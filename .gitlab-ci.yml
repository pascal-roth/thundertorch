image: "python:3.6"

before_script:
  - python --version
  - sh ./InstallThunderTorch.sh -a; echo $?
  # - pip install -r requirements.txt

stages:
#  - Static Analysis
#  - Formatting
#  - Security
  - Test
  - deploy

#mypy:
#  stage: Static Analysis
#  script:
#  - python -m mypy thunder_torch/*.py

#flake8:
#  stage: Static Analysis
#  script:
#  - flake8 --max-line-length=120 --max-complexity 8 bild/*.py
#
#pylint:
#  stage: Static Analysis
#  script:
#  - pylint -d C0301 -d R0902 bild/*.py

#isort:
#  stage: Formatting
#  script:
#  - isort .

#safety:
#  stage: Security
#  script:
#  - safety check

pytest:
  stage: Test
  script:
    - pwd
    - ls -l
    - export PYTHONPATH="$PYTHONPATH:."
    - python -c "import sys;print(sys.path)"
    - pytest test --ignore=test/ML_utils/models/test_LightningFlexMLP_integration.py --ignore=test/ML_utils/models/test_LightningFlexNN_integration.py

coverage:
  stage: Test
  allow_failure: true
  script:
  - pytest --cov-report term-missing --cov=thunder_torch



#stages:
#  - build
#  - test
#  - deploy
##   - merge
#
#Clear conda environment:
#    stage: .pre
#    script:
#        - echo "Removing preexisting environment"
#        - source ~/miniconda3/etc/profile.d/conda.sh
#        - conda remove --name thunder_torch --all
#
#
#Test Code:
#    stage: test
#    script:
#        - echo "Load Conda Environment"
#        - source ~/miniconda3/etc/profile.d/conda.sh
#        - source ~/miniconda3/bin/activate
#        - conda activate thunder_torch
#        - pytest test  --ignore=test/thunder_torch/models/test_LightningFlexNN_integration.py
##    only:
##        - devel
#
#Build Code:
#   stage: build
#   script:
#     - ./InstallThunderTorch.sh -a; echo $?
##   only:
##     - devel
#
pages:
  stage: deploy
  script:
#        - echo "Load Conda Environment"
#        - source ~/miniconda3/etc/profile.d/conda.sh
#        - source ~/miniconda3/bin/activate
#        - conda activate thunder_torch
        - echo "Build the documentation"
        - cd doc/
        - make clean; make html;
        - cd ../
        - mkdir public
        - cp -r doc/build/html/* public/
#  after_script:
#        - echo "Removing environment"
#        - source ~/miniconda3/etc/profile.d/conda.sh
#        - conda remove --name thunder_torch --all
  artifacts:
    paths:
        - public
#  only:
#    - devel

#Merge Code:
#    stage: merge
#    script:
#        - git fetch origin master
#        - git checkout master
#        - git pull
#        - git merge origin/develop -m "automatic merge of devel into master after sucessfull test"
#        - git status
#        - git push git@git.rwth-aachen.de:stfs/proth/pythonToolBox.git master
#    only:
#        - devel
